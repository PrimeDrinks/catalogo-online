<script>
  // N√∫mero do WhatsApp
  const WHATSAPP_NUMBER = "5585988743547";

  // Links das planilhas (CSV)
  const PRODUCTS_SHEET_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcX1AMiR5abZ4ZS8R0dRDRCEuFA7Z8F4pxdKnytA4KXSJMv28X3at9GmElefI6fo78Qf04ljMWB2q0/pub?gid=0&single=true&output=csv";

  const TAXAS_SHEET_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQcX1AMiR5abZ4ZS8R0dRDRCEuFA7Z8F4pxdKnytA4KXSJMv28X3at9GmElefI6fo78Qf04ljMWB2q0/pub?gid=1515986149&single=true&output=csv";

  // Hor√°rio de funcionamento
  const SCHEDULE_TEXT =
    "Ter√ßa a S√°bado: 8h √†s 22h; domingo 9h √†s 21h; segunda: fechado.";

  let isOpenNow = true;

  function isStoreOpen(now) {
    const day = now.getDay(); // 0=Dom, 1=Seg...
    const hour = now.getHours() + now.getMinutes() / 60;

    switch (day) {
      case 1: // Segunda
        return false;
      case 2: // Ter√ßa
      case 3: // Quarta
      case 4: // Quinta
      case 5: // Sexta
      case 6: // S√°bado
        return hour >= 8 && hour < 22;
      case 0: // Domingo
        return hour >= 9 && hour < 21;
      default:
        return false;
    }
  }

  function checkStoreOpen() {
    const now = new Date();
    isOpenNow = isStoreOpen(now);

    const statusEl = document.getElementById("storeStatus");
    if (!statusEl) return;

    if (isOpenNow) {
      statusEl.textContent =
        "Estamos atendendo agora! Hor√°rio de funcionamento: " + SCHEDULE_TEXT;
      statusEl.classList.remove("store-closed");
      statusEl.classList.add("store-open");
    } else {
      statusEl.textContent =
        "Estamos fora do hor√°rio de atendimento no momento. Nosso hor√°rio √©: " + SCHEDULE_TEXT;
      statusEl.classList.remove("store-open");
      statusEl.classList.add("store-closed");
    }

    renderCart();
  }

  // Estado carregado da planilha
  let products = [];
  let NEIGHBORHOODS = {};
  let formaPagamentoTexto = "";

  // Carrinho
  const cart = [];

  // üîπ Decide qual pre√ßo usar (normal ou atacado) com base na quantidade no carrinho
  function getEffectiveUnitPrice(cartItem) {
    const product = products.find(p => p.id == cartItem.id);
    if (!product) {
      // fallback: se por algum motivo n√£o achar, usa o que estiver salvo no item
      return cartItem.price || 0;
    }

    const min = Number(product.atacadoMinQty || 0);
    const atacadoPrice = Number(product.priceAtacado || 0);

    if (min > 0 && atacadoPrice > 0 && cartItem.quantity >= min) {
      return atacadoPrice; // usa pre√ßo atacado
    }

    return product.price || 0; // usa pre√ßo normal
  }

  function formatCurrency(value) {
    return Number(value || 0).toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });
  }

  // Parser CSV
  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];

    const parseLine = (line) => {
      const result = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === "," && !inQuotes) {
          result.push(current);
          current = "";
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    };

    const header = parseLine(lines[0]).map(h => h.trim());
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i];
      if (!line.trim()) continue;
      const cols = parseLine(line);
      const obj = {};
      header.forEach((h, idx) => {
        obj[h] = (cols[idx] || "").trim();
      });
      rows.push(obj);
    }

    return rows;
  }

  // Carregar produtos da aba Produtos (AGORA COM ATACADO)
  async function loadProductsFromSheet() {
    const res = await fetch(PRODUCTS_SHEET_URL);
    const csv = await res.text();
    const rows = parseCSV(csv);

    products = rows.map(row => {
      // pre√ßo normal (varejo)
      const precoStr = row.preco || row["preco"] || "0";
      const price = parseFloat(precoStr.replace(".", "").replace(",", ".")) || 0;

      const estoqueStr = row.estoque || "0";
      const estoque = parseInt(estoqueStr, 10) || 0;

      // üîπ NOVO: pre√ßo atacado
      const precoAtacadoStr = row.preco_atacado || row["preco_atacado"] || "0";
      const priceAtacado = parseFloat(precoAtacadoStr.replace(".", "").replace(",", ".")) || 0;

      // üîπ NOVO: quantidade m√≠nima para atacado
      const minAtacadoStr = row.quantidade_minima_atacado || row["quantidade_minima_atacado"] || "0";
      const atacadoMinQty = parseInt(minAtacadoStr, 10) || 0;

      let img = (row.imagem || "").trim();
      if (img && !/^https?:\/\//i.test(img) && !img.startsWith("data:")) {
        img = "images/" + img;
      }

      const promoFlag = (row.promo || "").toString().toLowerCase() === "true";

      return {
        id: row.id,
        name: row.nome,
        price,                 // pre√ßo normal (varejo)
        priceAtacado,          // üîπ pre√ßo atacado
        atacadoMinQty,         // üîπ quantidade m√≠nima para atacado
        category: row.categoria || "",
        estoque,
        image: img || "logo-prime.png",
        promo: promoFlag
      };
    });
  }

  // Carregar bairros + taxa + forma_pagamento
  async function loadTaxasFromSheet() {
    const res = await fetch(TAXAS_SHEET_URL);
    const csv = await res.text();
    const rows = parseCSV(csv);

    NEIGHBORHOODS = {};
    formaPagamentoTexto = "";

    rows.forEach(row => {
      const bairro = row.bairro || row["bairro"];
      if (!bairro) return;
      const taxaStr = row.taxa_entrega || row["taxa_entrega"] || "0";
      const taxa = parseFloat(taxaStr.replace(".", "").replace(",", ".")) || 0;
      NEIGHBORHOODS[bairro] = taxa;

      const fp = row.forma_pagamento || row.formas_pagamento || "";
      if (!formaPagamentoTexto && fp.trim()) {
        formaPagamentoTexto = fp.trim();
      }
    });

    // Bairros
    const neighborhoodSelect = document.getElementById("deliveryNeighborhood");
    if (neighborhoodSelect) {
      neighborhoodSelect.innerHTML =
        '<option value="">Selecione a localidade/bairro</option>';
      Object.keys(NEIGHBORHOODS).forEach(bairro => {
        const opt = document.createElement("option");
        opt.value = bairro;
        opt.textContent = bairro;
        neighborhoodSelect.appendChild(opt);
      });
    }

    // Formas de pagamento
    const paymentSelect = document.getElementById("paymentMethod");
    if (paymentSelect && formaPagamentoTexto) {
      paymentSelect.innerHTML = '<option value="">Selecione</option>';
      formaPagamentoTexto.split(",").forEach(item => {
        const txt = item.trim();
        if (!txt) return;
        const opt = document.createElement("option");
        opt.value = txt;
        opt.textContent = txt;
        paymentSelect.appendChild(opt);
      });
    }
  }

  function loadCategories() {
    const select = document.getElementById("categoryFilter");
    const shortcutsContainer = document.getElementById("categoryShortcuts");

    select.innerHTML = '<option value="">Todas as categorias</option>';
    const categories = [...new Set(products.map(p => p.category))].filter(Boolean).sort();

    // select
    categories.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat;
      option.innerText = cat;
      select.appendChild(option);
    });

    // atalhos
    if (shortcutsContainer) {
      shortcutsContainer.innerHTML = "";

      const allBtn = document.createElement("button");
      allBtn.textContent = "Todos";
      allBtn.className = "cat-pill cat-pill-active";
      allBtn.dataset.categoryValue = "";
      shortcutsContainer.appendChild(allBtn);

      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.className = "cat-pill";
        btn.dataset.categoryValue = cat;
        shortcutsContainer.appendChild(btn);
      });

      shortcutsContainer.addEventListener("click", (e) => {
        const btn = e.target.closest(".cat-pill");
        if (!btn) return;
        const value = btn.dataset.categoryValue || "";

        select.value = value;

        shortcutsContainer.querySelectorAll(".cat-pill").forEach(b => {
          b.classList.toggle("cat-pill-active", b === btn);
        });

        applyFilters();
      });
    }

    select.addEventListener("change", () => {
      const value = select.value || "";
      if (shortcutsContainer) {
        shortcutsContainer.querySelectorAll(".cat-pill").forEach(b => {
          const v = b.dataset.categoryValue || "";
          b.classList.toggle("cat-pill-active", v === value);
        });
      }
      applyFilters();
    });
  }

  // Promo√ß√£o em destaque
  function renderPromo() {
    const promoSection = document.getElementById("promoSection");
    const promoCard = document.getElementById("promoCard");
    if (!promoSection || !promoCard) return;

    const promoProduct =
      products.find(p => p.promo) ||
      products.find(p => (p.category || "").toLowerCase() === "combos");

    if (!promoProduct) {
      promoSection.style.display = "none";
      return;
    }

    const priceText = formatCurrency(promoProduct.price);

    promoCard.innerHTML = `
      <div class="promo-label">Oferta especial ‚Ä¢ Hoje</div>
      <div class="promo-name">${promoProduct.name}</div>
      <div class="promo-desc">
        Combo perfeito para o fim de semana na Prime Drinks Express. Ideal para reunir a galera e tomar aquela gelada! V√°lido at√© durar estoque.
      </div>
      <div class="promo-bottom">
        <div class="promo-price">${priceText}</div>
        <button
          class="promo-btn"
          type="button"
          onclick="addPromoToCart('${promoProduct.id}')"
        >
          <span>üõí</span> Adicionar combo ao pedido
        </button>
      </div>
    `;
  }

  function addPromoToCart(productId) {
    const product = products.find(p => p.id == productId);
    if (!product) return;

    const existing = cart.find(item => item.id == productId);
    const estoque = Number(product.estoque || 0);
    const alreadyInCart = existing ? existing.quantity : 0;

    if (alreadyInCart + 1 > estoque) {
      alert(`N√£o h√° estoque suficiente da promo√ß√£o. Estoque dispon√≠vel: ${estoque}.`);
      return;
    }

    if (existing) {
      existing.quantity += 1;
    } else {
      cart.push({
        id: product.id,
        name: product.name,
        quantity: 1
      });
    }
    renderCart();
  }

  function renderProducts(list) {
    const container = document.getElementById("productList");
    container.innerHTML = "";

    list.forEach(prod => {
      const estoque = Number(prod.estoque || 0);
      const isOut = estoque <= 0;
      const hasAtacado = prod.atacadoMinQty > 0 && prod.priceAtacado > 0;

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <img src="${prod.image}" alt="${prod.name}">
        <div class="card-body">
          <div class="card-title">${prod.name}</div>
          <div class="category">${prod.category}</div>
          <div class="price">${formatCurrency(prod.price)}</div>
          ${
            hasAtacado
              ? `<div class="stock">Atacado: ${formatCurrency(prod.priceAtacado)} a partir de ${prod.atacadoMinQty} un.</div>`
              : ""
          }
          <div class="stock ${isOut ? "stock-zero" : ""}">
            ${isOut ? "Estoque: esgotado" : "Estoque: " + estoque}
          </div>
        </div>
        <div class="card-footer">
          <div class="qty-row">
            ${
              isOut
                ? `<button class="btn-add btn-add-disabled" disabled>Produto esgotado</button>`
                : `
                  <input id="qty-${prod.id}" type="number" min="1" placeholder="Qtd.">
                  <button class="btn-add" onclick="addToCart('${prod.id}')">
                    Adicionar ao pedido
                  </button>
                `
            }
          </div>
        </div>
      `;

      container.appendChild(card);
    });
  }

  function applyFilters() {
    const category = document.getElementById("categoryFilter").value;
    const search = document
      .getElementById("searchInput")
      .value.toLowerCase()
      .trim();

    const filtered = products.filter(p => {
      const matchesCategory = !category || p.category === category;
      const matchesSearch = !search || (p.name || "").toLowerCase().includes(search);
      return matchesCategory && matchesSearch;
    });

    renderProducts(filtered);
  }

  function getOrderType() {
    const sel = document.getElementById("orderType");
    return sel ? (sel.value || "entrega") : "entrega";
  }

  function getDeliveryFee() {
    const orderType = getOrderType();
    if (orderType === "retirada") return 0;

    const select = document.getElementById("deliveryNeighborhood");
    if (!select) return 0;
    const Localidade = select.value;
    if (Localidade && NEIGHBORHOODS[Localidade] != null) {
      return NEIGHBORHOODS[Localidade];
    }
    return 0;
  }

  function getPaymentMethod() {
    const select = document.getElementById("paymentMethod");
    return select ? select.value : "";
  }

  function getCreditFee(subtotal, deliveryFee) {
    const method = (getPaymentMethod() || "").toLowerCase();
    if (method.includes("cr√©dito") || method.includes("credito")) {
      const base = subtotal + deliveryFee;
      return base * 0.04;
    }
    return 0;
  }

  function addToCart(productId) {
    const input = document.getElementById(`qty-${productId}`);
    let qty = parseInt(input.value, 10);

    if (isNaN(qty) || qty <= 0) {
      alert("Informe uma quantidade v√°lida.");
      return;
    }

    const product = products.find(p => p.id == productId);
    if (!product) return;

    const estoque = Number(product.estoque || 0);

    const existing = cart.find(item => item.id == productId);
    const alreadyInCart = existing ? existing.quantity : 0;

    if (qty + alreadyInCart > estoque) {
      alert(
        `Quantidade solicitada (${qty + alreadyInCart}) √© maior que o estoque dispon√≠vel (${estoque}).`
      );
      return;
    }

    if (existing) {
      existing.quantity += qty;
    } else {
      cart.push({
        id: product.id,
        name: product.name,
        quantity: qty
      });
    }

    input.value = "";
    renderCart();
  }

  function renderCart() {
    const container = document.getElementById("cartItems");
    const totalEl = document.getElementById("cartTotal");
    const subtotalEl = document.getElementById("cartSubtotal");
    const deliveryEl = document.getElementById("cartDelivery");
    const creditEl = document.getElementById("cartCreditFee");
    const btn = document.getElementById("whatsCartButton");

    container.innerHTML = "";

    if (!cart.length) {
      container.innerHTML = `<div class="cart-empty">Seu pedido ainda est√° vazio. Adicione itens do cat√°logo para continuar.</div>`;
      if (subtotalEl) subtotalEl.textContent = "R$ 0,00";
      if (deliveryEl) deliveryEl.textContent = "R$ 0,00";
      if (creditEl) creditEl.textContent = "R$ 0,00";
      totalEl.textContent = "R$ 0,00";
      btn.disabled = true;
      return;
    }

    let subtotal = 0;

    cart.forEach(item => {
      const unitPrice = getEffectiveUnitPrice(item);
      const lineTotal = unitPrice * item.quantity;
      subtotal += lineTotal;

      const row = document.createElement("div");
      row.className = "cart-item";

      row.innerHTML = `
        <div class="cart-item-left">
          <span class="cart-item-name">${item.name}</span>
          <span class="cart-item-qty">${item.quantity} x ${formatCurrency(unitPrice)}</span>
        </div>
        <div class="cart-item-right">
          ${formatCurrency(lineTotal)}
        </div>
      `;

      container.appendChild(row);
    });

    const deliveryFee = getDeliveryFee();
    const creditFee = getCreditFee(subtotal, deliveryFee);
    const total = subtotal + deliveryFee + creditFee;

    if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
    if (deliveryEl) deliveryEl.textContent = formatCurrency(deliveryFee);
    if (creditEl) creditEl.textContent = formatCurrency(creditFee);
    totalEl.textContent = formatCurrency(total);

    btn.disabled = !cart.length || !isOpenNow;
  }

  function sendCartToWhatsApp() {
    if (!cart.length) return;

    if (!isOpenNow) {
      alert("No momento estamos fora do hor√°rio de atendimento.\n\nNosso hor√°rio √©: " + SCHEDULE_TEXT);
      return;
    }

    const orderType = getOrderType();
    const neighborhoodSelect = document.getElementById("deliveryNeighborhood");
    const Localidade = neighborhoodSelect ? neighborhoodSelect.value : "";
    const paymentMethod = getPaymentMethod();
    const notesEl = document.getElementById("orderNotes");
    const notes = notesEl ? notesEl.value.trim() : "";

    let lines = [];
    lines.push("Ol√°! Gostaria de fazer o seguinte pedido:");
    lines.push("");

    let subtotal = 0;

    cart.forEach(item => {
      const unitPrice = getEffectiveUnitPrice(item);
      const lineTotal = unitPrice * item.quantity;
      subtotal += lineTotal;
      lines.push(`- ${item.quantity} x ${item.name} (${formatCurrency(unitPrice)}) = ${formatCurrency(lineTotal)}`);
    });

    lines.push("");

    const deliveryFee = getDeliveryFee();
    const creditFee = getCreditFee(subtotal, deliveryFee);
    const total = subtotal + deliveryFee + creditFee;

    if (orderType === "retirada") {
      lines.push(`Subtotal: ${formatCurrency(subtotal)}`);
      if (creditFee > 0) {
        lines.push(`Acr√©scimo cr√©dito: ${formatCurrency(creditFee)}`);
      }
      lines.push(`Total a pagar na retirada: ${formatCurrency(total)}`);
      lines.push("");
      lines.push("Tipo de pedido: RETIRADA NO LOCAL");
      lines.push("");
      lines.push("Hor√°rio para retirada: ");
      lines.push("");
    } else {
      lines.push(`Subtotal: ${formatCurrency(subtotal)}`);
      if (deliveryFee > 0) {
        lines.push(`Entrega${Localidade ? " (" + Localidade + ")" : ""}: ${formatCurrency(deliveryFee)}`);
      } else {
        lines.push("Entrega: a combinar conforme a localidade.");
      }
      if (creditFee > 0) {
        lines.push(`Acr√©scimo cr√©dito: ${formatCurrency(creditFee)}`);
      }
      lines.push(`Total: ${formatCurrency(total)}`);
      lines.push("");
      lines.push("Tipo de pedido: ENTREGA EM DOMIC√çLIO");
      lines.push("");
      if (Localidade) {
        lines.push(`Localidade/Bairro: ${Localidade}`);
      } else {
        lines.push("Localidade/Bairro: (informar)");
      }
      lines.push("");
      lines.push("Endere√ßo para entrega: ");
      lines.push("");
    }

    if (paymentMethod) {
      lines.push(`Forma de pagamento: ${paymentMethod}`);
    } else {
      lines.push("Forma de pagamento: (informar)");
    }

    if (notes) {
      lines.push("");
      lines.push("Observa√ß√µes:");
      lines.push(notes);
    }

    const text = lines.join("\n");
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;

    window.open(url, "_blank");
  }

  document.addEventListener("DOMContentLoaded", () => {
    checkStoreOpen();

    Promise.all([loadProductsFromSheet(), loadTaxasFromSheet()])
      .then(() => {
        loadCategories();
        renderPromo();
        applyFilters();
        renderCart();
      })
      .catch(err => {
        console.error("Erro ao carregar dados das planilhas:", err);
        renderProducts([]);
        renderCart();
      });

    document
      .getElementById("whatsCartButton")
      .addEventListener("click", sendCartToWhatsApp);

    const neighborhoodSelect = document.getElementById("deliveryNeighborhood");
    if (neighborhoodSelect) {
      neighborhoodSelect.addEventListener("change", renderCart);
    }

    const paymentSelect = document.getElementById("paymentMethod");
    if (paymentSelect) {
      paymentSelect.addEventListener("change", renderCart);
    }

    const orderTypeSelect = document.getElementById("orderType");
    if (orderTypeSelect) {
      orderTypeSelect.addEventListener("change", () => {
        const neighborhoodSelect = document.getElementById("deliveryNeighborhood");
        if (neighborhoodSelect) {
          if (orderTypeSelect.value === "retirada") {
            neighborhoodSelect.disabled = true;
            neighborhoodSelect.value = "";
          } else {
            neighborhoodSelect.disabled = false;
          }
        }
        renderCart();
      });
    }

    const searchInput = document.getElementById("searchInput");
    if (searchInput) {
      searchInput.addEventListener("input", applyFilters);
    }

    setInterval(checkStoreOpen, 60000);
  });
</script>
